<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $data['title']; ?> - PHOENIX</title>
    <link rel="stylesheet" href="/phoenix/assets/css/phoenix-core.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: linear-gradient(135deg, #0a0a12 0%, #0d1420 50%, #0a0a12 100%);
            color: var(--brand-text-primary);
            font-family: 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background: rgba(15, 15, 20, 0.95);
            border-bottom: 1px solid var(--brand-border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #22c55e, #4ade80);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title p {
            font-size: 0.85rem;
            color: var(--brand-text-tertiary);
        }

        .header-stats {
            display: flex;
            gap: 24px;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #22c55e;
        }

        .header-stat-label {
            font-size: 0.75rem;
            color: var(--brand-text-tertiary);
            text-transform: uppercase;
        }

        .nickname-btn {
            padding: 8px 16px;
            background: var(--brand-panel);
            border: 1px solid var(--brand-border);
            border-radius: 8px;
            color: var(--brand-text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .nickname-btn:hover {
            border-color: #22c55e;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 360px;
            height: calc(100vh - 81px);
        }

        /* Map Container */
        .map-container {
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #1a1a24;
        }

        /* Custom Leaflet styling */
        .leaflet-container {
            background: #1a1a24;
            font-family: inherit;
        }

        .leaflet-control-zoom a {
            background: var(--brand-panel) !important;
            color: var(--brand-text-primary) !important;
            border-color: var(--brand-border) !important;
        }

        .leaflet-control-zoom a:hover {
            background: var(--brand-muted) !important;
        }

        .leaflet-control-attribution {
            background: rgba(15, 15, 20, 0.9) !important;
            color: var(--brand-text-tertiary) !important;
        }

        .leaflet-popup-content-wrapper {
            background: var(--brand-panel);
            color: var(--brand-text-primary);
            border-radius: 12px;
            border: 1px solid var(--brand-border);
        }

        .leaflet-popup-tip {
            background: var(--brand-panel);
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 16px;
            left: 60px;
            z-index: 500;
            display: flex;
            gap: 8px;
        }

        .map-btn {
            padding: 10px 16px;
            background: rgba(15, 15, 20, 0.95);
            border: 1px solid var(--brand-border);
            border-radius: 8px;
            color: var(--brand-text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }

        .map-btn:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .map-btn.active {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }

        .map-btn.primary {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            font-weight: 600;
        }

        .map-btn.primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        /* Sidebar */
        .sidebar {
            background: rgba(15, 15, 20, 0.95);
            border-left: 1px solid var(--brand-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--brand-border);
        }

        .sidebar-tab {
            flex: 1;
            padding: 14px;
            background: transparent;
            border: none;
            color: var(--brand-text-tertiary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .sidebar-tab:hover {
            color: var(--brand-text-primary);
            background: rgba(255, 255, 255, 0.02);
        }

        .sidebar-tab.active {
            color: #22c55e;
            border-bottom: 2px solid #22c55e;
            margin-bottom: -1px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Report Form */
        .report-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 0.85rem;
            color: var(--brand-text-secondary);
            font-weight: 500;
        }

        .form-input, .form-select, .form-textarea {
            padding: 12px 14px;
            background: var(--brand-panel);
            border: 1px solid var(--brand-border);
            border-radius: 8px;
            color: var(--brand-text-primary);
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-select {
            cursor: pointer;
        }

        /* Photo Upload */
        .photo-upload {
            border: 2px dashed var(--brand-border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .photo-upload:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.05);
        }

        .photo-upload.has-image {
            padding: 0;
            border-style: solid;
        }

        .photo-upload input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .photo-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
        }

        .photo-placeholder {
            color: var(--brand-text-tertiary);
        }

        .photo-placeholder-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        /* AI Identify Button */
        .ai-identify-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .ai-identify-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .ai-identify-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ai-suggestion {
            background: rgba(124, 58, 237, 0.1);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }

        .ai-suggestion-header {
            font-size: 0.8rem;
            color: #a855f7;
            margin-bottom: 6px;
        }

        .ai-suggestion-text {
            font-size: 0.95rem;
            color: var(--brand-text-primary);
        }

        /* Location Display */
        .location-display {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--brand-panel);
            border: 1px solid var(--brand-border);
            border-radius: 8px;
        }

        .location-icon {
            font-size: 1.5rem;
        }

        .location-text {
            flex: 1;
        }

        .location-coords {
            font-size: 0.8rem;
            color: var(--brand-text-tertiary);
        }

        .location-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--brand-border);
            border-radius: 6px;
            color: var(--brand-text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .location-btn:hover {
            border-color: #22c55e;
            color: #22c55e;
        }

        /* Submit Button */
        .submit-btn {
            padding: 14px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3);
        }

        .submit-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Recent Sightings */
        .sightings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sighting-card {
            background: var(--brand-panel);
            border: 1px solid var(--brand-border);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sighting-card:hover {
            border-color: rgba(34, 197, 94, 0.5);
            transform: translateX(4px);
        }

        .sighting-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .sighting-icon {
            font-size: 1.5rem;
        }

        .sighting-species {
            font-weight: 600;
            flex: 1;
        }

        .sighting-time {
            font-size: 0.8rem;
            color: var(--brand-text-tertiary);
        }

        .sighting-location {
            font-size: 0.85rem;
            color: var(--brand-text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sighting-photo {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        .sighting-notes {
            font-size: 0.85rem;
            color: var(--brand-text-tertiary);
            margin-top: 8px;
            font-style: italic;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 6px 12px;
            background: var(--brand-panel);
            border: 1px solid var(--brand-border);
            border-radius: 20px;
            color: var(--brand-text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover, .filter-chip.active {
            border-color: #22c55e;
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        /* Stats Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: var(--brand-panel);
            border: 1px solid var(--brand-border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }

        .stat-box-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #22c55e;
        }

        .stat-box-label {
            font-size: 0.8rem;
            color: var(--brand-text-tertiary);
            text-transform: uppercase;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--brand-text-tertiary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 14px 24px;
            background: var(--brand-panel);
            border: 1px solid var(--brand-border);
            border-radius: 10px;
            color: var(--brand-text-primary);
            font-weight: 500;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .toast.error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        /* Nickname Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--brand-panel);
            border: 1px solid var(--brand-border);
            border-radius: 16px;
            padding: 28px;
            width: 100%;
            max-width: 400px;
            margin: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            color: var(--brand-text-tertiary);
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.secondary {
            background: var(--brand-muted);
            border: 1px solid var(--brand-border);
            color: var(--brand-text-primary);
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
        }

        /* Popup Content */
        .popup-content {
            min-width: 200px;
        }

        .popup-species {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .popup-photo {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .popup-notes {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 8px;
        }

        .popup-meta {
            font-size: 0.8rem;
            color: #666;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }

        /* Auth UI */
        .header-auth {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .auth-loading {
            display: flex;
            align-items: center;
        }

        .auth-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(34, 197, 94, 0.2);
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .auth-logged-out, .auth-logged-in {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .auth-btn-primary {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .auth-btn-primary:hover {
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            transform: translateY(-1px);
        }

        .auth-btn-secondary {
            background: var(--brand-panel);
            border-color: var(--brand-border);
            color: var(--brand-text-primary);
        }

        .auth-btn-secondary:hover {
            border-color: #22c55e;
            color: #22c55e;
        }

        .auth-btn-admin {
            background: rgba(255, 170, 0, 0.1);
            border-color: #ffaa00;
            color: #ffaa00;
        }

        .auth-btn-admin:hover {
            background: rgba(255, 170, 0, 0.2);
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--brand-panel);
            border: 1px solid var(--brand-border);
            border-radius: 20px;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .user-role-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .user-role-badge.trusted { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .user-role-badge.moderator { background: rgba(255, 170, 0, 0.2); color: #ffaa00; }
        .user-role-badge.admin { background: rgba(0, 255, 136, 0.2); color: #00ff88; }

        /* Submission status badge */
        .sighting-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .sighting-status-badge.pending {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }

        .sighting-status-badge.approved {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: 50vh 1fr;
            }

            .sidebar {
                border-left: none;
                border-top: 1px solid var(--brand-border);
            }

            .header-stats {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <div class="logo-icon">üåø</div>
            <div class="header-title">
                <h1><?php echo $data['title']; ?></h1>
                <p><?php echo $data['subtitle']; ?></p>
            </div>
        </div>
        <div class="header-stats">
            <div class="header-stat">
                <div class="header-stat-value" id="stat-total"><?php echo $data['stats']['total']; ?></div>
                <div class="header-stat-label">Total Sightings</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="stat-week"><?php echo $data['stats']['week']; ?></div>
                <div class="header-stat-label">This Week</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="stat-today"><?php echo $data['stats']['today']; ?></div>
                <div class="header-stat-label">Today</div>
            </div>
        </div>
        <!-- Auth UI -->
        <div class="header-auth" id="auth-section">
            <div class="auth-loading" id="auth-loading">
                <span class="auth-spinner"></span>
            </div>
            <div class="auth-logged-out" id="auth-logged-out" style="display: none;">
                <a href="/en/login" class="auth-btn auth-btn-secondary">Log In</a>
                <a href="/en/register" class="auth-btn auth-btn-primary">Sign Up</a>
            </div>
            <div class="auth-logged-in" id="auth-logged-in" style="display: none;">
                <div class="user-badge" id="user-badge">
                    <span class="user-avatar" id="user-avatar">?</span>
                    <span class="user-name" id="user-name">User</span>
                    <span class="user-role-badge" id="user-role-badge"></span>
                </div>
                <button class="nickname-btn" onclick="showNicknameModal()">
                    <span id="nickname-display">Set Nickname</span>
                </button>
                <a href="/en/admin-nature-watch" class="auth-btn auth-btn-admin" id="admin-link" style="display: none;">Admin</a>
                <button class="auth-btn auth-btn-secondary" onclick="logout()">Log Out</button>
            </div>
        </div>
        <!-- Nickname for anonymous users -->
        <button class="nickname-btn" id="anon-nickname-btn" onclick="showNicknameModal()" style="display: none;">
            <span id="anon-nickname-display">Set Nickname</span>
        </button>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-btn" onclick="centerOnUser()">
                    üìç My Location
                </button>
                <button class="map-btn" id="pick-location-btn" onclick="toggleLocationPicker()">
                    üéØ Pick Location
                </button>
                <button class="map-btn" id="filter-mine-btn" onclick="toggleMyFilter()">
                    üë§ My Sightings
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="switchTab('report')">Report</button>
                <button class="sidebar-tab" onclick="switchTab('recent')">Recent</button>
                <button class="sidebar-tab" onclick="switchTab('stats')">Stats</button>
            </div>

            <div class="sidebar-content">
                <!-- Report Tab -->
                <div class="tab-panel active" id="tab-report">
                    <form class="report-form" id="sighting-form" onsubmit="submitSighting(event)">
                        <!-- Photo Upload -->
                        <div class="form-group">
                            <label class="form-label">Photo (optional)</label>
                            <div class="photo-upload" id="photo-upload">
                                <input type="file" accept="image/*" onchange="handlePhotoSelect(event)">
                                <div class="photo-placeholder" id="photo-placeholder">
                                    <div class="photo-placeholder-icon">üì∑</div>
                                    <div>Click or drag photo here</div>
                                </div>
                                <img class="photo-preview" id="photo-preview" style="display: none;">
                            </div>
                            <button type="button" class="ai-identify-btn" id="ai-identify-btn" onclick="identifyWithAI()" disabled>
                                ü§ñ What is this animal?
                            </button>
                            <div class="ai-suggestion" id="ai-suggestion" style="display: none;">
                                <div class="ai-suggestion-header">AI Suggestion</div>
                                <div class="ai-suggestion-text" id="ai-suggestion-text"></div>
                            </div>
                        </div>

                        <!-- Species -->
                        <div class="form-group">
                            <label class="form-label">Species *</label>
                            <select class="form-select" id="species-select" required>
                                <option value="">Select species...</option>
                                <?php foreach ($data['species_categories'] as $catKey => $category): ?>
                                    <optgroup label="<?php echo $category['icon'] . ' ' . $category['label']; ?>">
                                        <?php foreach ($category['species'] as $species): ?>
                                            <option value="<?php echo htmlspecialchars($species); ?>" data-category="<?php echo $catKey; ?>">
                                                <?php echo htmlspecialchars($species); ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </optgroup>
                                <?php endforeach; ?>
                            </select>
                        </div>

                        <!-- Location -->
                        <div class="form-group">
                            <label class="form-label">Location *</label>
                            <div class="location-display" id="location-display">
                                <span class="location-icon">üìç</span>
                                <div class="location-text">
                                    <div id="location-name">Click map or use My Location</div>
                                    <div class="location-coords" id="location-coords"></div>
                                </div>
                                <button type="button" class="location-btn" onclick="centerOnUser()">Detect</button>
                            </div>
                            <input type="hidden" id="latitude" name="latitude">
                            <input type="hidden" id="longitude" name="longitude">
                        </div>

                        <!-- Notes -->
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="notes" placeholder="Describe what you observed... behavior, number of animals, etc."></textarea>
                        </div>

                        <!-- Submit -->
                        <button type="submit" class="submit-btn" id="submit-btn">
                            üåø Submit Sighting
                        </button>
                    </form>
                </div>

                <!-- Recent Tab -->
                <div class="tab-panel" id="tab-recent">
                    <div class="filter-bar">
                        <button class="filter-chip active" data-category="all" onclick="filterByCategory('all', this)">All</button>
                        <?php foreach ($data['species_categories'] as $catKey => $category): ?>
                            <button class="filter-chip" data-category="<?php echo $catKey; ?>" onclick="filterByCategory('<?php echo $catKey; ?>', this)">
                                <?php echo $category['icon']; ?>
                            </button>
                        <?php endforeach; ?>
                    </div>
                    <div class="sightings-list" id="sightings-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <div>Loading sightings...</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Tab -->
                <div class="tab-panel" id="tab-stats">
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-box-value" id="stats-total">0</div>
                            <div class="stat-box-label">Total</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value" id="stats-species">0</div>
                            <div class="stat-box-label">Species</div>
                        </div>
                    </div>
                    <div id="stats-species-list"></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Nickname Modal -->
    <div class="modal-overlay" id="nickname-modal">
        <div class="modal">
            <div class="modal-title">üë§ Set Your Nickname</div>
            <div class="modal-subtitle">Your nickname will appear with your sightings so you can track them.</div>
            <input type="text" class="form-input" id="nickname-input" placeholder="Enter nickname..." maxlength="30">
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeNicknameModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveNickname()">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
        // ============================================
        // State
        // ============================================
        const state = {
            map: null,
            markers: new Map(),
            userMarker: null,
            pickingLocation: false,
            selectedLocation: null,
            photoFile: null,
            photoPath: null,
            nickname: localStorage.getItem('naturewatch_nickname') || '',
            observerId: localStorage.getItem('naturewatch_observer_id') || generateObserverId(),
            currentFilter: 'all',
            showOnlyMine: false,
            isAuthenticated: false,
            user: null
        };

        const categoryIcons = <?php echo json_encode(array_map(function($c) { return $c['icon']; }, $data['species_categories'])); ?>;

        // ============================================
        // Initialize
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadSightings();
            loadStats();
            checkAuthState();

            // Only show nickname modal for non-authenticated users
            if (!state.nickname && !state.isAuthenticated) {
                setTimeout(() => {
                    if (!state.isAuthenticated) showNicknameModal();
                }, 2000);
            }
        });

        // ============================================
        // Auth
        // ============================================
        async function checkAuthState() {
            try {
                const formData = new FormData();
                formData.append('gate', 'users');
                formData.append('action', 'check_auth');

                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                state.isAuthenticated = result.authenticated;
                state.user = result.user || null;

                updateAuthUI();
            } catch (error) {
                console.error('Auth check failed:', error);
                updateAuthUI();
            }
        }

        function updateAuthUI() {
            const loading = document.getElementById('auth-loading');
            const loggedOut = document.getElementById('auth-logged-out');
            const loggedIn = document.getElementById('auth-logged-in');
            const anonNickname = document.getElementById('anon-nickname-btn');
            const adminLink = document.getElementById('admin-link');

            loading.style.display = 'none';

            if (state.isAuthenticated && state.user) {
                loggedOut.style.display = 'none';
                loggedIn.style.display = 'flex';
                anonNickname.style.display = 'none';

                // Update user info
                document.getElementById('user-avatar').textContent = state.user.username.charAt(0).toUpperCase();
                document.getElementById('user-name').textContent = state.user.username;

                // Role badge
                const roleBadge = document.getElementById('user-role-badge');
                const role = parseInt(state.user.role);
                if (role >= 10) {
                    roleBadge.textContent = 'Admin';
                    roleBadge.className = 'user-role-badge admin';
                } else if (role >= 5) {
                    roleBadge.textContent = 'Mod';
                    roleBadge.className = 'user-role-badge moderator';
                } else if (role >= 2) {
                    roleBadge.textContent = 'Trusted';
                    roleBadge.className = 'user-role-badge trusted';
                } else {
                    roleBadge.style.display = 'none';
                }

                // Show admin link for mods+
                if (role >= 5) {
                    adminLink.style.display = 'inline-flex';
                }

                // Use username as nickname if not set
                if (!state.nickname) {
                    state.nickname = state.user.username;
                    updateNicknameDisplay();
                }
            } else {
                loggedOut.style.display = 'flex';
                loggedIn.style.display = 'none';
                anonNickname.style.display = 'flex';
                updateNicknameDisplay();
            }
        }

        async function logout() {
            try {
                const formData = new FormData();
                formData.append('gate', 'users');
                formData.append('action', 'logout');

                await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                state.isAuthenticated = false;
                state.user = null;
                localStorage.removeItem('nature_watch_user');
                updateAuthUI();
                showToast('Logged out successfully', 'success');
            } catch (error) {
                showToast('Logout failed', 'error');
            }
        }

        function generateObserverId() {
            const id = 'nw_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('naturewatch_observer_id', id);
            return id;
        }

        // ============================================
        // Map
        // ============================================
        function initMap() {
            state.map = L.map('map').setView([39.8283, -98.5795], 4); // US center

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(state.map);

            // Click to pick location
            state.map.on('click', (e) => {
                if (state.pickingLocation) {
                    setSelectedLocation(e.latlng.lat, e.latlng.lng);
                    toggleLocationPicker();
                }
            });

            // Try to get user location on load
            centerOnUser();
        }

        function centerOnUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        state.map.setView([latitude, longitude], 14);
                        setSelectedLocation(latitude, longitude, 'Your Location');

                        if (state.userMarker) {
                            state.userMarker.setLatLng([latitude, longitude]);
                        } else {
                            state.userMarker = L.circleMarker([latitude, longitude], {
                                radius: 8,
                                fillColor: '#22c55e',
                                color: '#fff',
                                weight: 2,
                                fillOpacity: 1
                            }).addTo(state.map);
                        }
                    },
                    (err) => {
                        showToast('Could not get location: ' + err.message, 'error');
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        function toggleLocationPicker() {
            state.pickingLocation = !state.pickingLocation;
            const btn = document.getElementById('pick-location-btn');
            btn.classList.toggle('active', state.pickingLocation);
            state.map.getContainer().style.cursor = state.pickingLocation ? 'crosshair' : '';
        }

        function setSelectedLocation(lat, lng, name = null) {
            state.selectedLocation = { lat, lng };
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            document.getElementById('location-coords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('location-name').textContent = name || 'Location selected';
        }

        // ============================================
        // Sightings
        // ============================================
        async function loadSightings() {
            try {
                const params = new URLSearchParams({
                    gate: 'wildlife',
                    action: 'get_sightings',
                    limit: 100
                });

                if (state.currentFilter !== 'all') {
                    params.append('category', state.currentFilter);
                }

                if (state.showOnlyMine) {
                    params.append('observer_id', state.observerId);
                }

                const response = await fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                const result = await response.json();
                if (result.success) {
                    displaySightings(result.data);
                    updateMapMarkers(result.data);
                }
            } catch (err) {
                console.error('Error loading sightings:', err);
            }
        }

        function displaySightings(sightings) {
            const container = document.getElementById('sightings-list');

            if (!sightings || sightings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ü¶å</div>
                        <div>No sightings yet. Be the first!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = sightings.map(s => `
                <div class="sighting-card" onclick="flyToSighting(${s.latitude}, ${s.longitude}, ${s.id})">
                    <div class="sighting-header">
                        <span class="sighting-icon">${getCategoryIcon(s.species_category)}</span>
                        <span class="sighting-species">${escapeHtml(s.species)}</span>
                        ${s.status === 'pending' ? '<span class="sighting-status-badge pending">Pending</span>' : ''}
                        <span class="sighting-time">${formatTimeAgo(s.sighting_date)}</span>
                    </div>
                    <div class="sighting-location">üìç ${s.location_name || formatCoords(s.latitude, s.longitude)}</div>
                    ${s.photo_path ? `<img class="sighting-photo" src="${s.photo_path}" alt="Sighting photo">` : ''}
                    ${s.notes ? `<div class="sighting-notes">"${escapeHtml(s.notes.substring(0, 100))}${s.notes.length > 100 ? '...' : ''}"</div>` : ''}
                </div>
            `).join('');
        }

        function updateMapMarkers(sightings) {
            // Clear existing markers
            state.markers.forEach(marker => marker.remove());
            state.markers.clear();

            // Add new markers
            sightings.forEach(s => {
                const icon = L.divIcon({
                    html: `<div style="font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">${getCategoryIcon(s.species_category)}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([s.latitude, s.longitude], { icon })
                    .bindPopup(createPopupContent(s))
                    .addTo(state.map);

                state.markers.set(s.id, marker);
            });
        }

        function createPopupContent(sighting) {
            return `
                <div class="popup-content">
                    <div class="popup-species">${getCategoryIcon(sighting.species_category)} ${escapeHtml(sighting.species)}</div>
                    ${sighting.photo_path ? `<img class="popup-photo" src="${sighting.photo_path}" alt="Photo">` : ''}
                    ${sighting.notes ? `<div class="popup-notes">${escapeHtml(sighting.notes)}</div>` : ''}
                    <div class="popup-meta">
                        üìç ${sighting.location_name || 'Unknown location'}<br>
                        üïê ${formatTimeAgo(sighting.sighting_date)}<br>
                        üë§ ${escapeHtml(sighting.observer_name)}
                    </div>
                </div>
            `;
        }

        function flyToSighting(lat, lng, id) {
            state.map.flyTo([lat, lng], 16, { duration: 0.5 });
            setTimeout(() => {
                const marker = state.markers.get(parseInt(id));
                if (marker) marker.openPopup();
            }, 600);
        }

        // ============================================
        // Photo Upload
        // ============================================
        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            state.photoFile = file;

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('photo-preview');
                const placeholder = document.getElementById('photo-placeholder');
                const upload = document.getElementById('photo-upload');

                preview.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                upload.classList.add('has-image');

                document.getElementById('ai-identify-btn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        async function uploadPhoto() {
            if (!state.photoFile) return null;

            const formData = new FormData();
            formData.append('gate', 'media_hub');
            formData.append('action', 'upload');
            formData.append('file', state.photoFile);

            try {
                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    return result.file.url;
                }
            } catch (err) {
                console.error('Photo upload error:', err);
            }
            return null;
        }

        // ============================================
        // AI Identification
        // ============================================
        async function identifyWithAI() {
            const btn = document.getElementById('ai-identify-btn');
            const suggestion = document.getElementById('ai-suggestion');
            const suggestionText = document.getElementById('ai-suggestion-text');

            btn.disabled = true;
            btn.textContent = 'üîÑ Analyzing...';

            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        gate: 'ai_chat',
                        message: 'I just saw an animal and took a photo. Based on the context of a nature/wildlife tracker app, can you suggest what common North American wildlife species this might be? Give me 2-3 likely species names that I can select from.',
                        system_prompt: 'You are a wildlife identification assistant. Suggest common species that users might encounter. Be helpful and provide 2-3 species names. Keep response brief.'
                    })
                });

                const result = await response.text();
                suggestionText.textContent = result;
                suggestion.style.display = 'block';
            } catch (err) {
                showToast('AI identification failed', 'error');
            }

            btn.disabled = false;
            btn.textContent = 'ü§ñ What is this animal?';
        }

        // ============================================
        // Submit Sighting
        // ============================================
        async function submitSighting(event) {
            event.preventDefault();

            const species = document.getElementById('species-select').value;
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;
            const notes = document.getElementById('notes').value;

            if (!species) {
                showToast('Please select a species', 'error');
                return;
            }

            if (!lat || !lng) {
                showToast('Please set a location', 'error');
                return;
            }

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Submitting...';

            // Upload photo first if present
            let photoPath = null;
            if (state.photoFile) {
                photoPath = await uploadPhoto();
            }

            // Get category from selected option
            const selectedOption = document.getElementById('species-select').selectedOptions[0];
            const category = selectedOption.dataset.category || 'other';

            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        gate: 'wildlife',
                        action: 'add_sighting',
                        species: species,
                        category: category,
                        latitude: lat,
                        longitude: lng,
                        notes: notes,
                        photo_path: photoPath || '',
                        observer_name: state.nickname || 'Anonymous',
                        observer_id: state.observerId,
                        sighting_date: new Date().toISOString().slice(0, 19).replace('T', ' ')
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('üéâ Sighting recorded! Thank you!', 'success');
                    resetForm();
                    loadSightings();
                    loadStats();
                } else {
                    showToast(result.error || 'Failed to save', 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'üåø Submit Sighting';
        }

        function resetForm() {
            document.getElementById('sighting-form').reset();
            document.getElementById('photo-preview').style.display = 'none';
            document.getElementById('photo-placeholder').style.display = 'block';
            document.getElementById('photo-upload').classList.remove('has-image');
            document.getElementById('ai-suggestion').style.display = 'none';
            document.getElementById('ai-identify-btn').disabled = true;
            document.getElementById('location-coords').textContent = '';
            document.getElementById('location-name').textContent = 'Click map or use My Location';
            state.photoFile = null;
            state.selectedLocation = null;
        }

        // ============================================
        // Stats
        // ============================================
        async function loadStats() {
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        gate: 'wildlife',
                        action: 'get_stats'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('stats-total').textContent = result.data.total;
                    document.getElementById('stat-total').textContent = result.data.total;
                    document.getElementById('stats-species').textContent = result.data.top_species.length;

                    const speciesList = document.getElementById('stats-species-list');
                    speciesList.innerHTML = result.data.top_species.map(s => `
                        <div class="sighting-card" style="cursor: default; margin-bottom: 8px;">
                            <div class="sighting-header">
                                <span class="sighting-icon">${getCategoryIcon(s.species_category)}</span>
                                <span class="sighting-species">${escapeHtml(s.species)}</span>
                                <span style="color: #22c55e; font-weight: 600;">${s.count}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        // ============================================
        // Filters
        // ============================================
        function filterByCategory(category, btn) {
            state.currentFilter = category;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            loadSightings();
        }

        function toggleMyFilter() {
            state.showOnlyMine = !state.showOnlyMine;
            document.getElementById('filter-mine-btn').classList.toggle('active', state.showOnlyMine);
            loadSightings();
        }

        // ============================================
        // Tabs
        // ============================================
        function switchTab(tabName) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ============================================
        // Nickname
        // ============================================
        function showNicknameModal() {
            document.getElementById('nickname-modal').classList.add('show');
            document.getElementById('nickname-input').value = state.nickname;
            document.getElementById('nickname-input').focus();
        }

        function closeNicknameModal() {
            document.getElementById('nickname-modal').classList.remove('show');
        }

        function saveNickname() {
            const name = document.getElementById('nickname-input').value.trim();
            state.nickname = name;
            localStorage.setItem('naturewatch_nickname', name);
            updateNicknameDisplay();
            closeNicknameModal();
            showToast('Nickname saved!', 'success');
        }

        function updateNicknameDisplay() {
            const display = state.nickname || 'Set Nickname';
            document.getElementById('nickname-display').textContent = display;
            document.getElementById('anon-nickname-display').textContent = display;
        }

        // ============================================
        // Utilities
        // ============================================
        function getCategoryIcon(category) {
            return categoryIcons[category] || 'üîç';
        }

        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
            return date.toLocaleDateString();
        }

        function formatCoords(lat, lng) {
            return `${parseFloat(lat).toFixed(4)}, ${parseFloat(lng).toFixed(4)}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>

/**
 * Create a new PHOENIX dashboard
 * Usage: Receives args via TOOL_ARGS environment variable
 */

import dashboardManager from '../lib/dashboard-manager.js';
import fs from 'fs';
import path from 'path';

const FRAMEWORK_PATH = process.env.FRAMEWORK_PATH || path.resolve(process.cwd(), '../..');

async function createDashboard() {
  console.log('ğŸ”¥ PHOENIX Create Dashboard');
  console.log('â•'.repeat(50));

  // Parse args from environment
  const args = JSON.parse(process.env.TOOL_ARGS || '{}');

  const {
    name = 'New Dashboard',
    route,
    template = 'dashboard',
    theme = 'dark',
    description = ''
  } = args;

  if (!route) {
    console.log('âŒ Error: route is required');
    process.exit(1);
  }

  try {
    // Load dashboard manager
    await dashboardManager.load();

    // Create dashboard in manager
    const dashboard = await dashboardManager.create({
      name,
      route,
      template,
      theme,
      description
    });

    // Generate actual files
    const routesPath = path.join(FRAMEWORK_PATH, 'framework/config/routes.cfg');
    const modelPath = path.join(FRAMEWORK_PATH, `framework/mvc/models/${route}.php`);
    const viewPath = path.join(FRAMEWORK_PATH, `framework/mvc/views/${route}.phtml`);

    // Add to routes
    const routes = fs.readFileSync(routesPath, 'utf8').split(',').map(r => r.trim());
    if (!routes.includes(route)) {
      routes.push(route);
      fs.writeFileSync(routesPath, routes.join(','));
      console.log(`âœ… Route added: ${route}`);
    }

    // Generate model
    const className = route.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('') + '_Model';
    const modelContent = `<?php
/**
 * ${name} - Generated by PHOENIX
 * Dashboard ID: ${dashboard.id}
 */

class ${className} {

    public static function Get_Data() {
        return [
            'title' => '${name}',
            'dashboard_id' => '${dashboard.id}',
            'theme' => '${theme}',

            // Dashboard data
            'stats' => [],
            'charts' => [],
            'tables' => []
        ];
    }
}
?>
`;
    fs.writeFileSync(modelPath, modelContent);
    console.log(`âœ… Model created: ${modelPath}`);

    // Generate view
    const viewContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= htmlspecialchars($data['title']) ?> - PHOENIX</title>

    <!-- PHOENIX Core -->
    <link rel="stylesheet" href="/phoenix/assets/css/phoenix-core.css">
    <link rel="stylesheet" href="/phoenix/templates/${template}/template.css">
</head>
<body class="phoenix-page theme-${theme}">

    <?php
    // Template configuration
    $config = [
        'title' => $data['title'],
        'theme' => $data['theme']
    ];

    // Slot content (populated by widgets)
    $slots = [];

    // Include template
    include dirname(dirname(__DIR__)) . '/phoenix/templates/${template}/template.phtml';
    ?>

    <!-- PHOENIX Core JS -->
    <script src="/phoenix/assets/js/phoenix-core.js"></script>
    <script src="/phoenix/templates/${template}/template.js"></script>

</body>
</html>
`;
    fs.writeFileSync(viewPath, viewContent);
    console.log(`âœ… View created: ${viewPath}`);

    console.log('');
    console.log('â•'.repeat(50));
    console.log(`ğŸ‰ Dashboard created successfully!`);
    console.log(`   ğŸ“Š Name: ${name}`);
    console.log(`   ğŸ”— URL: /en/${route}`);
    console.log(`   ğŸ¨ Theme: ${theme}`);
    console.log(`   ğŸ“ Template: ${template}`);
    console.log('');

  } catch (error) {
    console.log(`âŒ Error: ${error.message}`);
    process.exit(1);
  }
}

createDashboard();
